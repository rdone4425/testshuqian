<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿå®‰è£… - ä¹¦ç­¾å¯¼èˆª</title>
    <link rel="stylesheet" href="/css/setup.css">
</head>
<body>
    <div class="setup-container">
        <div class="setup-card">
            <h1>ğŸ“š ä¹¦ç­¾å¯¼èˆªç³»ç»Ÿå®‰è£…</h1>

            <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
            <div class="steps">
                <div class="step active" id="step1">
                    <span class="step-number">1</span>
                    <span class="step-text">æ£€æµ‹æ•°æ®åº“</span>
                </div>
                <div class="step" id="step2">
                    <span class="step-number">2</span>
                    <span class="step-text">åˆ›å»ºè¡¨æ ¼</span>
                </div>
                <div class="step" id="step3">
                    <span class="step-number">3</span>
                    <span class="step-text">è®¾ç½®è´¦å·</span>
                </div>
                <div class="step" id="step4">
                    <span class="step-number">4</span>
                    <span class="step-text">å®Œæˆå®‰è£…</span>
                </div>
            </div>

            <!-- å®‰è£…å†…å®¹åŒºåŸŸ -->
            <div class="setup-content">

                <!-- æ­¥éª¤1: æ£€æµ‹æ•°æ®åº“ç»‘å®š -->
                <div class="setup-step" id="content-step1">
                    <h2>ğŸ” æ£€æµ‹ D1 æ•°æ®åº“ç»‘å®š</h2>
                    <div class="status-box">
                        <div class="loading" id="db-checking">
                            <div class="spinner"></div>
                            <span>æ­£åœ¨æ£€æµ‹æ•°æ®åº“ç»‘å®š...</span>
                        </div>
                        <div class="success hidden" id="db-success">
                            <div class="icon">âœ…</div>
                            <div class="info">
                                <h3>æ•°æ®åº“ç»‘å®šæˆåŠŸ</h3>
                                <p>æ•°æ®åº“åç§°: <strong id="db-name">-</strong></p>
                                <p>ç»‘å®šçŠ¶æ€: <span class="status-ok">å·²è¿æ¥</span></p>
                            </div>
                        </div>
                        <div class="error hidden" id="db-error">
                            <div class="icon">âŒ</div>
                            <div class="info">
                                <h3>æ•°æ®åº“ç»‘å®šå¤±è´¥</h3>
                                <p id="db-error-msg">è¯·ç¡®ä¿å·²åœ¨ Cloudflare Pages ä¸­ç»‘å®š D1 æ•°æ®åº“</p>
                                <button class="btn-retry" onclick="checkDatabase()">é‡æ–°æ£€æµ‹</button>
                            </div>
                        </div>
                    </div>
                    <div class="step-actions">
                        <button class="btn-primary" id="btn-next-1" onclick="nextStep(2)" disabled>ä¸‹ä¸€æ­¥</button>
                        <button class="btn-secondary" onclick="manualCheckDatabase()">æ‰‹åŠ¨æ£€æµ‹æ•°æ®åº“</button>
                    </div>
                </div>

                <!-- æ­¥éª¤2: åˆ›å»ºæ•°æ®åº“è¡¨æ ¼ -->
                <div class="setup-step hidden" id="content-step2">
                    <h2>ğŸ—„ï¸ åˆ›å»ºæ•°æ®åº“è¡¨æ ¼</h2>
                    <div class="table-creation">
                        <div class="table-item">
                            <span class="table-name">users (ç”¨æˆ·è¡¨)</span>
                            <span class="table-status" id="users-status">â³ ç­‰å¾…åˆ›å»º</span>
                        </div>
                        <div class="table-item">
                            <span class="table-name">categories (åˆ†ç±»è¡¨)</span>
                            <span class="table-status" id="categories-status">â³ ç­‰å¾…åˆ›å»º</span>
                        </div>
                        <div class="table-item">
                            <span class="table-name">bookmarks (ä¹¦ç­¾è¡¨)</span>
                            <span class="table-status" id="bookmarks-status">â³ ç­‰å¾…åˆ›å»º</span>
                        </div>
                    </div>
                    <div class="creation-log">
                        <h4>åˆ›å»ºæ—¥å¿—:</h4>
                        <div class="log-content" id="creation-log"></div>
                    </div>
                    <div class="step-actions">
                        <button class="btn-secondary" onclick="prevStep(1)">ä¸Šä¸€æ­¥</button>
                        <button class="btn-primary" id="btn-create-tables" onclick="createTables()">åˆ›å»ºè¡¨æ ¼</button>
                        <button class="btn-primary hidden" id="btn-next-2" onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
                    </div>
                </div>

                <!-- æ­¥éª¤3: è®¾ç½®ç®¡ç†å‘˜è´¦å· -->
                <div class="setup-step hidden" id="content-step3">
                    <h2>ğŸ‘¤ è®¾ç½®ç®¡ç†å‘˜è´¦å·</h2>
                    <form class="admin-form" id="admin-form">
                        <div class="form-group">
                            <label for="admin-username">ç®¡ç†å‘˜ç”¨æˆ·å:</label>
                            <input type="text" id="admin-username" name="username" required
                                   placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜ç”¨æˆ·å" minlength="3" maxlength="20">
                            <small>ç”¨æˆ·åé•¿åº¦ 3-20 ä¸ªå­—ç¬¦</small>
                        </div>
                        <div class="form-group">
                            <label for="admin-password">ç®¡ç†å‘˜å¯†ç :</label>
                            <input type="password" id="admin-password" name="password" required
                                   placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç " minlength="6">
                            <small>å¯†ç è‡³å°‘ 6 ä¸ªå­—ç¬¦</small>
                        </div>
                        <div class="form-group">
                            <label for="admin-password-confirm">ç¡®è®¤å¯†ç :</label>
                            <input type="password" id="admin-password-confirm" name="passwordConfirm" required
                                   placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                        </div>
                        <div class="form-group">
                            <label for="admin-email">é‚®ç®± (å¯é€‰):</label>
                            <input type="email" id="admin-email" name="email"
                                   placeholder="ç”¨äºå¯†ç æ‰¾å›">
                        </div>
                    </form>
                    <div class="step-actions">
                        <button class="btn-secondary" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                        <button class="btn-primary" id="btn-create-admin" onclick="createAdmin()">åˆ›å»ºç®¡ç†å‘˜</button>
                    </div>
                </div>

                <!-- æ­¥éª¤4: å®‰è£…å®Œæˆ -->
                <div class="setup-step hidden" id="content-step4">
                    <h2>ğŸ‰ å®‰è£…å®Œæˆ</h2>
                    <div class="success-info">
                        <div class="success-icon">âœ¨</div>
                        <h3>æ­å–œï¼ç³»ç»Ÿå®‰è£…æˆåŠŸ</h3>
                        <div class="install-summary">
                            <p>âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ</p>
                            <p>âœ… æ•°æ®è¡¨åˆ›å»ºå®Œæˆ</p>
                            <p>âœ… ç®¡ç†å‘˜è´¦å·è®¾ç½®å®Œæˆ</p>
                        </div>
                        <div class="next-steps">
                            <h4>æ¥ä¸‹æ¥ä½ å¯ä»¥:</h4>
                            <ul>
                                <li>ç™»å½•ç®¡ç†åå°æ·»åŠ ä¹¦ç­¾åˆ†ç±»</li>
                                <li>å¯¼å…¥ç°æœ‰ä¹¦ç­¾æ•°æ®</li>
                                <li>è‡ªå®šä¹‰ç½‘ç«™å¤–è§‚</li>
                            </ul>
                        </div>
                    </div>
                    <div class="step-actions">
                        <button class="btn-primary btn-large" onclick="goToLogin()">å‰å¾€ç™»å½•</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // ç®€åŒ–çš„å®‰è£…ç®¡ç†å™¨
        let currentStep = 1;
        let dbInfo = null;

        // æ‰‹åŠ¨æ£€æµ‹æ•°æ®åº“
        async function manualCheckDatabase() {
            console.log('æ‰‹åŠ¨æ£€æµ‹æ•°æ®åº“...');

            try {
                const response = await fetch('/api/setup/check-database');
                const result = await response.json();

                console.log('æ•°æ®åº“æ£€æµ‹ç»“æœ:', result);

                if (result.success) {
                    // æˆåŠŸ
                    document.getElementById('db-checking').classList.add('hidden');
                    document.getElementById('db-success').classList.remove('hidden');
                    document.getElementById('db-error').classList.add('hidden');
                    document.getElementById('db-name').textContent = result.data.name || 'D1 Database';
                    document.getElementById('btn-next-1').disabled = false;
                    dbInfo = result.data;
                    alert('æ•°æ®åº“æ£€æµ‹æˆåŠŸï¼');
                } else {
                    throw new Error(result.message || 'æ£€æµ‹å¤±è´¥');
                }
            } catch (error) {
                console.error('æ£€æµ‹å¤±è´¥:', error);
                document.getElementById('db-checking').classList.add('hidden');
                document.getElementById('db-success').classList.add('hidden');
                document.getElementById('db-error').classList.remove('hidden');
                document.getElementById('db-error-msg').textContent = error.message;
                alert('æ•°æ®åº“æ£€æµ‹å¤±è´¥: ' + error.message);
            }
        }

        // è‡ªåŠ¨æ£€æµ‹æ•°æ®åº“ï¼ˆé¡µé¢åŠ è½½åï¼‰
        async function autoCheckDatabase() {
            // å»¶è¿Ÿ3ç§’åè‡ªåŠ¨æ£€æµ‹
            setTimeout(async () => {
                try {
                    await manualCheckDatabase();
                } catch (error) {
                    console.log('è‡ªåŠ¨æ£€æµ‹å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ç‚¹å‡»æ£€æµ‹æŒ‰é’®');
                }
            }, 3000);
        }

        // æ­¥éª¤å¯¼èˆª
        function nextStep(step) {
            hideAllSteps();
            showStep(step);
            updateStepIndicator(step);
            currentStep = step;
        }

        function prevStep(step) {
            hideAllSteps();
            showStep(step);
            updateStepIndicator(step);
            currentStep = step;
        }

        function hideAllSteps() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`content-step${i}`).classList.add('hidden');
            }
        }

        function showStep(step) {
            document.getElementById(`content-step${step}`).classList.remove('hidden');
        }

        function updateStepIndicator(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');

                if (i < currentStep) {
                    stepEl.classList.add('completed');
                } else if (i === currentStep) {
                    stepEl.classList.add('active');
                }
            }
        }

        // åˆ›å»ºè¡¨æ ¼
        async function createTables() {
            const createBtn = document.getElementById('btn-create-tables');
            const nextBtn = document.getElementById('btn-next-2');

            createBtn.disabled = true;
            createBtn.textContent = 'åˆ›å»ºä¸­...';

            const tables = [
                {
                    name: 'users',
                    sql: `CREATE TABLE IF NOT EXISTS users (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        username TEXT UNIQUE NOT NULL,
                        password TEXT NOT NULL,
                        email TEXT,
                        role TEXT DEFAULT 'admin',
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    )`
                },
                {
                    name: 'categories',
                    sql: `CREATE TABLE IF NOT EXISTS categories (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        name TEXT NOT NULL,
                        description TEXT,
                        icon TEXT,
                        sort_order INTEGER DEFAULT 0,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
                    )`
                },
                {
                    name: 'bookmarks',
                    sql: `CREATE TABLE IF NOT EXISTS bookmarks (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        title TEXT NOT NULL,
                        url TEXT NOT NULL,
                        description TEXT,
                        icon TEXT,
                        category_id INTEGER,
                        sort_order INTEGER DEFAULT 0,
                        is_featured BOOLEAN DEFAULT 0,
                        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (category_id) REFERENCES categories (id)
                    )`
                }
            ];

            let successCount = 0;

            for (const table of tables) {
                try {
                    document.getElementById(`${table.name}-status`).textContent = 'â³ åˆ›å»ºä¸­...';

                    const response = await fetch('/api/setup/create-table', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            tableName: table.name,
                            sql: table.sql
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        document.getElementById(`${table.name}-status`).textContent = 'âœ… åˆ›å»ºæˆåŠŸ';
                        successCount++;
                    } else {
                        throw new Error(result.message || 'åˆ›å»ºå¤±è´¥');
                    }

                    await new Promise(resolve => setTimeout(resolve, 500));

                } catch (error) {
                    document.getElementById(`${table.name}-status`).textContent = 'âŒ åˆ›å»ºå¤±è´¥';
                    console.error(`è¡¨æ ¼ ${table.name} åˆ›å»ºå¤±è´¥:`, error);
                }
            }

            createBtn.textContent = 'åˆ›å»ºè¡¨æ ¼';
            createBtn.disabled = false;

            if (successCount === tables.length) {
                createBtn.classList.add('hidden');
                nextBtn.classList.remove('hidden');
                alert('æ‰€æœ‰è¡¨æ ¼åˆ›å»ºå®Œæˆï¼');
            } else {
                alert(`åˆ›å»ºå®Œæˆï¼ŒæˆåŠŸ: ${successCount}/${tables.length}`);
            }
        }

        // åˆ›å»ºç®¡ç†å‘˜
        async function createAdmin() {
            const form = document.getElementById('admin-form');
            const formData = new FormData(form);
            const createBtn = document.getElementById('btn-create-admin');

            const username = formData.get('username');
            const password = formData.get('password');
            const passwordConfirm = formData.get('passwordConfirm');
            const email = formData.get('email');

            if (!username || username.length < 3) {
                alert('ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦');
                return;
            }

            if (!password || password.length < 6) {
                alert('å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦');
                return;
            }

            if (password !== passwordConfirm) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }

            createBtn.disabled = true;
            createBtn.textContent = 'åˆ›å»ºä¸­...';

            try {
                const response = await fetch('/api/setup/create-admin', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password,
                        email
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸï¼');
                    nextStep(4);
                } else {
                    throw new Error(result.message || 'ç®¡ç†å‘˜è´¦å·åˆ›å»ºå¤±è´¥');
                }

            } catch (error) {
                console.error('åˆ›å»ºç®¡ç†å‘˜å¤±è´¥:', error);
                alert('åˆ›å»ºç®¡ç†å‘˜å¤±è´¥: ' + error.message);
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'åˆ›å»ºç®¡ç†å‘˜';
            }
        }

        // å‰å¾€ç™»å½•é¡µé¢
        function goToLogin() {
            window.location.href = '/login.html';
        }

        // å…¼å®¹åŸæœ‰çš„å‡½æ•°è°ƒç”¨
        function checkDatabase() {
            manualCheckDatabase();
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹æ•°æ®åº“
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œ3ç§’åè‡ªåŠ¨æ£€æµ‹æ•°æ®åº“...');
            autoCheckDatabase();
        });
    </script>
</body>
</html>
