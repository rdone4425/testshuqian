# 🔧 自动修复功能使用指南

## 功能概述

当系统检测到数据库不完整时（如显示"不完整 (67%)"），现在会自动提示并跳转到修复页面。

## 🚀 自动跳转触发场景

### 1. 仪表板页面加载时
- **触发时机**: 访问 `/dashboard.html` 页面时
- **检测延迟**: 页面加载后 2 秒自动检测
- **行为**: 如果检测到数据库不完整，弹出确认对话框
- **选择**: 用户可以选择立即修复或稍后处理

### 2. 数据库状态刷新时
- **触发时机**: 点击"刷新统计"按钮时
- **行为**: 检测到不完整状态时，1 秒后弹出修复确认
- **显示**: 状态栏显示"不完整 (XX%)"并提供修复选项

### 3. 定期监控检测
- **触发时机**: 每 60 秒自动检测一次
- **行为**: 检测到问题时显示右上角通知
- **通知内容**: 
  - 缺失的表列表
  - 完整性百分比
  - "立即修复"和"稍后处理"按钮
- **自动消失**: 15 秒后通知自动消失

## 🎯 使用流程

### 正常使用流程：
1. **访问仪表板** → 自动检测数据库状态
2. **发现不完整** → 弹出修复确认对话框
3. **选择修复** → 自动跳转到修复页面
4. **完成修复** → 返回仪表板，状态恢复正常

### 手动触发修复：
1. 在仪表板中点击"不完整"状态
2. 使用调试页面的"测试自动修复跳转"按钮
3. 通过监控通知的"立即修复"按钮

## 🔍 测试方法

### 快速测试步骤：

1. **删除一个表**（模拟不完整状态）：
   ```bash
   wrangler d1 execute bookmark-nav-db --command="DROP TABLE IF EXISTS categories;"
   ```

2. **访问仪表板**：
   ```
   http://localhost:8788/dashboard.html
   ```

3. **观察自动检测**：
   - 页面加载 2 秒后应该弹出修复确认
   - 状态栏显示"不完整 (67%)"
   - 右上角可能出现监控通知

4. **测试修复跳转**：
   - 点击"是"确认修复
   - 应该自动跳转到：`/setup.html?mode=repair&missing=["categories"]`

### 使用调试工具测试：

访问调试页面：
```
http://localhost:8788/debug-tables.html
```

测试功能：
- 点击"检测表状态"查看当前状态
- 点击"测试自动修复跳转"验证跳转逻辑
- 使用"删除 categories 表"模拟不完整状态

## ⚙️ 配置选项

### 监控间隔调整
在 `database.js` 中修改监控间隔：
```javascript
// 默认 60 秒，可以调整为其他值
window.dbMonitor.startMonitoring(30000); // 30 秒
```

### 禁用自动检测
如果需要禁用自动检测，可以注释掉相关代码：
```javascript
// 在 database.js 的 DOMContentLoaded 事件中注释掉自动检测部分
```

### 自定义确认对话框
可以修改确认对话框的文本内容，在相关文件中搜索 `confirm(` 进行自定义。

## 🎨 用户体验优化

### 友好的提示信息
- 显示具体的缺失表名称
- 显示完整性百分比
- 提供明确的操作选项

### 非侵入式通知
- 右上角通知不会阻塞用户操作
- 自动消失避免界面混乱
- 提供"稍后处理"选项

### 智能跳转
- 携带缺失表信息到修复页面
- 修复页面自动识别修复模式
- 只修复缺失的表，保留现有数据

## 🐛 故障排除

### 如果自动检测不工作：

1. **检查控制台错误**：
   - 打开浏览器开发者工具
   - 查看 Console 标签页的错误信息

2. **验证 API 可用性**：
   ```bash
   curl http://localhost:8788/api/setup/check-tables
   ```

3. **检查数据库绑定**：
   ```bash
   wrangler d1 list
   ```

4. **重启开发服务器**：
   ```bash
   cd website
   wrangler pages dev . --d1 DB=your-db-name
   ```

### 常见问题：

- **"数据库监控模块未加载"** → 检查 `database.js` 是否正确引入
- **"API 返回 HTML"** → 检查 Functions 路由配置
- **"跳转失败"** → 检查 URL 参数编码是否正确

## 📝 注意事项

1. **测试环境使用** - 请在开发环境中测试，避免影响生产数据
2. **数据备份** - 删除表前确保有数据备份
3. **用户体验** - 自动跳转会打断用户当前操作，请谨慎使用
4. **性能考虑** - 频繁的数据库检测可能影响性能，建议合理设置检测间隔

## 🎯 预期效果

启用自动修复功能后：
- ✅ 用户无需手动检查数据库状态
- ✅ 问题发现后立即得到修复提示
- ✅ 一键跳转到修复页面
- ✅ 智能修复，只处理缺失的表
- ✅ 修复完成后系统恢复正常运行

这样用户在看到"不完整 (67%)"状态时，系统会主动引导进行修复，提供更好的用户体验。
