<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å• API æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #005a87;
        }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .loading { color: #007cba; }
    </style>
</head>
<body>
    <h1>ğŸ”§ å¿«é€Ÿ API è¯Šæ–­</h1>
    
    <div class="test-box">
        <h3>å½“å‰ç¯å¢ƒä¿¡æ¯</h3>
        <div id="env-info" class="result"></div>
        <button class="btn" onclick="showEnvInfo()">æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯</button>
    </div>

    <div class="test-box">
        <h3>æµ‹è¯• API è¿æ¥</h3>
        <div id="api-result" class="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
        <button class="btn" onclick="testAPI()">æµ‹è¯•æ•°æ®åº“ API</button>
        <button class="btn" onclick="testRawAPI()">æµ‹è¯•åŸå§‹å“åº”</button>
    </div>

    <script>
        function showEnvInfo() {
            const info = {
                'å½“å‰URL': window.location.href,
                'åè®®': window.location.protocol,
                'ä¸»æœº': window.location.host,
                'ç«¯å£': window.location.port || 'é»˜è®¤ç«¯å£',
                'è·¯å¾„': window.location.pathname,
                'æ—¶é—´': new Date().toISOString(),
                'ç”¨æˆ·ä»£ç†': navigator.userAgent.substring(0, 100) + '...'
            };
            
            document.getElementById('env-info').textContent = JSON.stringify(info, null, 2);
        }

        async function testAPI() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'ğŸ” æ­£åœ¨æµ‹è¯• API...';
            resultEl.className = 'result loading';

            try {
                console.log('å¼€å§‹æµ‹è¯• API...');
                
                const response = await fetch('/api/setup/check-database', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                console.log('æ”¶åˆ°å“åº”:', response);
                console.log('å“åº”çŠ¶æ€:', response.status);
                console.log('å“åº”å¤´:', Object.fromEntries(response.headers));

                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);

                // å…ˆè·å–åŸå§‹æ–‡æœ¬
                const responseText = await response.text();
                console.log('å“åº”æ–‡æœ¬:', responseText);

                let result = {
                    status: response.status,
                    statusText: response.statusText,
                    contentType: contentType,
                    headers: Object.fromEntries(response.headers),
                    responseText: responseText
                };

                // å°è¯•è§£æ JSON
                if (contentType && contentType.includes('application/json')) {
                    try {
                        result.jsonData = JSON.parse(responseText);
                    } catch (jsonError) {
                        result.jsonError = jsonError.message;
                    }
                }

                resultEl.textContent = JSON.stringify(result, null, 2);
                
                if (response.ok && contentType && contentType.includes('application/json')) {
                    resultEl.className = 'result success';
                } else {
                    resultEl.className = 'result error';
                }

            } catch (error) {
                console.error('API æµ‹è¯•å¤±è´¥:', error);
                resultEl.textContent = `âŒ æµ‹è¯•å¤±è´¥:\n${error.message}\n\nå †æ ˆ:\n${error.stack}`;
                resultEl.className = 'result error';
            }
        }

        async function testRawAPI() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'ğŸ” æ­£åœ¨æµ‹è¯•åŸå§‹ API å“åº”...';
            resultEl.className = 'result loading';

            try {
                // ä½¿ç”¨ XMLHttpRequest è·å–æ›´è¯¦ç»†çš„ä¿¡æ¯
                const xhr = new XMLHttpRequest();
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        const result = {
                            readyState: xhr.readyState,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            responseURL: xhr.responseURL,
                            responseText: xhr.responseText,
                            responseHeaders: xhr.getAllResponseHeaders()
                        };
                        
                        resultEl.textContent = JSON.stringify(result, null, 2);
                        
                        if (xhr.status === 200) {
                            resultEl.className = 'result success';
                        } else {
                            resultEl.className = 'result error';
                        }
                    }
                };

                xhr.onerror = function() {
                    resultEl.textContent = `âŒ XMLHttpRequest é”™è¯¯:\nçŠ¶æ€: ${xhr.status}\nå“åº”: ${xhr.responseText}`;
                    resultEl.className = 'result error';
                };

                xhr.open('GET', '/api/setup/check-database', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send();

            } catch (error) {
                console.error('åŸå§‹ API æµ‹è¯•å¤±è´¥:', error);
                resultEl.textContent = `âŒ åŸå§‹æµ‹è¯•å¤±è´¥:\n${error.message}`;
                resultEl.className = 'result error';
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
        window.onload = function() {
            showEnvInfo();
        };
    </script>
</body>
</html>
