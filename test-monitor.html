<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“ç›‘æ§æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .btn:hover {
            background: #005a87;
        }

        .btn-warning {
            background: #e67e22;
        }

        .btn-warning:hover {
            background: #d35400;
        }

        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: 500;
            display: inline-block;
            margin: 5px;
        }

        .status-healthy {
            background: #d4edda;
            color: #155724;
        }

        .status-incomplete {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ•°æ®åº“ç›‘æ§æµ‹è¯•å·¥å…·</h1>
        
        <div class="card">
            <h3>åŸºç¡€æ£€æµ‹</h3>
            <button class="btn" onclick="testConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
            <button class="btn" onclick="testTables()">æ£€æµ‹è¡¨å®Œæ•´æ€§</button>
            <button class="btn" onclick="testSystemIntegrity()">æ£€æµ‹ç³»ç»Ÿå®Œæ•´æ€§</button>
            <div id="basic-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>ç›‘æ§åŠŸèƒ½</h3>
            <button class="btn" onclick="startMonitoring()">å¯åŠ¨ç›‘æ§</button>
            <button class="btn btn-warning" onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
            <button class="btn" onclick="getStatus()">è·å–çŠ¶æ€æ‘˜è¦</button>
            <div id="monitor-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>ä¿®å¤åŠŸèƒ½</h3>
            <button class="btn btn-warning" onclick="simulateTableDrop()">æ¨¡æ‹Ÿåˆ é™¤è¡¨ (æµ‹è¯•ç”¨)</button>
            <button class="btn" onclick="autoRepair()">è‡ªåŠ¨ä¿®å¤</button>
            <div id="repair-result" class="result" style="display: none;"></div>
        </div>

        <div class="card">
            <h3>å®æ—¶çŠ¶æ€</h3>
            <div id="status-display">
                <span class="status status-healthy">ç­‰å¾…æ£€æµ‹...</span>
            </div>
            <div id="status-details" style="margin-top: 10px; font-size: 14px; color: #666;"></div>
        </div>
    </div>

    <script src="/js/utils/database.js"></script>
    <script>
        let monitoringActive = false;

        // æ˜¾ç¤ºç»“æœ
        function showResult(containerId, data) {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            container.textContent = JSON.stringify(data, null, 2);
        }

        // æµ‹è¯•æ•°æ®åº“è¿æ¥
        async function testConnection() {
            try {
                const result = await window.dbMonitor.checkConnection();
                showResult('basic-result', result);
            } catch (error) {
                showResult('basic-result', { error: error.message });
            }
        }

        // æµ‹è¯•è¡¨å®Œæ•´æ€§
        async function testTables() {
            try {
                const result = await window.dbMonitor.checkTables();
                showResult('basic-result', result);
            } catch (error) {
                showResult('basic-result', { error: error.message });
            }
        }

        // æµ‹è¯•ç³»ç»Ÿå®Œæ•´æ€§
        async function testSystemIntegrity() {
            try {
                const result = await window.dbMonitor.checkSystemIntegrity();
                showResult('basic-result', result);
                updateStatusDisplay(result);
            } catch (error) {
                showResult('basic-result', { error: error.message });
            }
        }

        // å¯åŠ¨ç›‘æ§
        function startMonitoring() {
            if (monitoringActive) {
                alert('ç›‘æ§å·²åœ¨è¿è¡Œ');
                return;
            }

            window.dbMonitor.startMonitoring(10000, (result) => {
                console.log('ç›‘æ§å›è°ƒ:', result);
                updateStatusDisplay(result);
                
                const monitorResult = document.getElementById('monitor-result');
                monitorResult.style.display = 'block';
                monitorResult.textContent = `ç›‘æ§æ›´æ–° ${new Date().toLocaleTimeString()}:\n${JSON.stringify(result, null, 2)}`;
            });

            monitoringActive = true;
            showResult('monitor-result', { message: 'ç›‘æ§å·²å¯åŠ¨ï¼Œæ£€æŸ¥é—´éš”: 10ç§’' });
        }

        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            window.dbMonitor.stopMonitoring();
            monitoringActive = false;
            showResult('monitor-result', { message: 'ç›‘æ§å·²åœæ­¢' });
        }

        // è·å–çŠ¶æ€æ‘˜è¦
        async function getStatus() {
            try {
                const result = await window.dbMonitor.getStatusSummary();
                showResult('monitor-result', result);
                updateStatusDisplay(result);
            } catch (error) {
                showResult('monitor-result', { error: error.message });
            }
        }

        // è‡ªåŠ¨ä¿®å¤
        async function autoRepair() {
            try {
                const result = await window.dbMonitor.autoRepair();
                showResult('repair-result', { 
                    message: result ? 'ä¿®å¤å·²å¯åŠ¨' : 'æ— éœ€ä¿®å¤æˆ–ç”¨æˆ·å–æ¶ˆ',
                    repairStarted: result 
                });
            } catch (error) {
                showResult('repair-result', { error: error.message });
            }
        }

        // æ¨¡æ‹Ÿåˆ é™¤è¡¨ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰
        async function simulateTableDrop() {
            if (!confirm('è¿™å°†åˆ é™¤ categories è¡¨ç”¨äºæµ‹è¯•ä¿®å¤åŠŸèƒ½ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            try {
                // æ³¨æ„ï¼šè¿™åªæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿï¼Œå®é™…ä¸ä¼šåˆ é™¤è¡¨
                alert('æ¨¡æ‹ŸåŠŸèƒ½ï¼šåœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œè¿™ä¼šåˆ é™¤ä¸€ä¸ªè¡¨æ¥æµ‹è¯•ä¿®å¤åŠŸèƒ½ã€‚\n\nè¯·æ‰‹åŠ¨åˆ é™¤ä¸€ä¸ªè¡¨æ¥æµ‹è¯•ä¿®å¤åŠŸèƒ½ã€‚');
                showResult('repair-result', { 
                    message: 'æ¨¡æ‹Ÿåˆ é™¤è¡¨å®Œæˆï¼Œè¯·åˆ·æ–°é¡µé¢æ£€æµ‹çŠ¶æ€' 
                });
            } catch (error) {
                showResult('repair-result', { error: error.message });
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(status) {
            const statusDisplay = document.getElementById('status-display');
            const statusDetails = document.getElementById('status-details');

            let statusClass, statusText;
            
            switch (status.status) {
                case 'healthy':
                    statusClass = 'status-healthy';
                    statusText = 'âœ… æ•°æ®åº“å¥åº·';
                    break;
                case 'incomplete':
                    statusClass = 'status-incomplete';
                    statusText = `âš ï¸ æ•°æ®åº“ä¸å®Œæ•´ (${status.completeness}%)`;
                    break;
                case 'error':
                    statusClass = 'status-error';
                    statusText = 'âŒ æ•°æ®åº“é”™è¯¯';
                    break;
                default:
                    statusClass = 'status-error';
                    statusText = 'â“ çŠ¶æ€æœªçŸ¥';
            }

            statusDisplay.innerHTML = `<span class="status ${statusClass}">${statusText}</span>`;
            statusDetails.textContent = `æ¶ˆæ¯: ${status.message} | æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}`;

            if (status.missingTables && status.missingTables.length > 0) {
                statusDetails.textContent += ` | ç¼ºå¤±è¡¨: ${status.missingTables.join(', ')}`;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('æ•°æ®åº“ç›‘æ§æµ‹è¯•é¡µé¢å·²åŠ è½½');
            
            // è‡ªåŠ¨æ£€æµ‹ä¸€æ¬¡çŠ¶æ€
            setTimeout(() => {
                testSystemIntegrity();
            }, 1000);
        });
    </script>
</body>
</html>
